#! /usr/bin/env bash

image=public.ecr.aws/sam/build-ruby3.2:latest-x86_64

function build() {
    source="$(pwd)/$1"
    build="$(pwd)/build"
    target="$build/$1"

    # rsync
    rsync -ar --delete --exclude=vendor "${source}" "${build}"

    pushd "${target}" || exit

        bundle config set --local path 'vendor/bundle'
        bundle config set --local without 'development:test'
        docker run --rm \
            -v "$target:/var/task" \
            --entrypoint="bundle" \
            --platform linux/amd64 \
            -e BUNDLE_SILENCE_ROOT_WARNING=1 \
            $image install -j 4

    popd || exit

}

function deploy() {
    pushd infra || exit
        terraform plan -out plan.json
        terraform apply plan.json
    popd || exit
}

build "hello-world"
build "countries"
deploy
