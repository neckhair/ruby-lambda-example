#! /usr/bin/env bash

function build() {
    source=$1
    build="$(pwd)/build"
    target="$build/$1"

    # rsync
    rsync -ar --delete --exclude=vendor "${source}" "${build}"

    pushd "${target}" || exit

        bundle config set --local path 'vendor/bundle'
        bundle config set --local without 'development:test'
        bundle check || bundle install -j 4
        bundle clean --force

    popd || exit

}

function deploy() {
    pushd infra || exit
        terraform plan -out plan.json
        terraform apply plan.json
    popd || exit
}

build "hello-world"
build "countries"
deploy
